version: "3.9"
services:
  mcp_tools:
    build:
      context: .
      dockerfile: mcp_tools/Dockerfile
    command: uvicorn mcp_tools.main:app --host 0.0.0.0 --port 3001
    ports:
      - "3001:3001"
    env_file:
      - .env
    environment:
      - PORT=3001
      - MCP_API_KEY=${MCP_API_KEY:-dev-key}
      - MCP_RATE_LIMIT=${MCP_RATE_LIMIT:-30/minute}
      - MCP_USER_AGENT=${MCP_USER_AGENT:-CityDayNavigator-MCP-Tool}
      - HTTP_TIMEOUT_SEC=${HTTP_TIMEOUT_SEC:-10}
      - EXCHANGERATE_API_KEY=${EXCHANGERATE_API_KEY:-your_api_key_here}
      - OPENAQ_API_KEY=${OPENAQ_API_KEY:-your_api_key_here}
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -sf -H 'X-API-KEY: ${MCP_API_KEY:-dev-key}' http://localhost:3001/ >/dev/null || exit 1"]
      interval: 20s
      timeout: 5s
      retries: 5
  orchestrator:
    build:
      context: .
      dockerfile: orchestrator/Dockerfile
    command: uvicorn orchestrator.main:app --host 0.0.0.0 --port 3002
    ports:
      - "3002:3002"
    env_file:
      - .env
    depends_on:
      mcp_tools:
        condition: service_healthy
    environment:
      - PORT=3002
      - MCP_API_KEY=${MCP_API_KEY:-dev-key}
      - MCP_TOOLS_URL=http://mcp_tools:3001
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - GEMINI_MODEL=${GEMINI_MODEL:-gemini-2.5-flash-preview-09-2025}
      - CLASSIFICATION_DEFAULT_DATE=${CLASSIFICATION_DEFAULT_DATE:-2025-11-10}
      - HTTP_TIMEOUT_SEC=${HTTP_TIMEOUT_SEC:-15}
      - NEARBY_RADIUS_M=${NEARBY_RADIUS_M:-3000}
      - NEARBY_LIMIT=${NEARBY_LIMIT:-1}
      - ROUTE_PROFILE_DEFAULT=${ROUTE_PROFILE_DEFAULT:-foot}
    restart: unless-stopped